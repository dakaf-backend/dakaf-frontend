<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">

<h1 class="text-3xl font-bold mb-6 text-center">Admin Product Upload</h1>

<form id="uploadForm" enctype="multipart/form-data">
  <div class="mb-4">
    <label class="block text-gray-700 font-bold mb-2" for="name">Product Name</label>
    <input type="text" id="name" name="name" required
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
  </div>

  <div class="mb-4">
    <label class="block text-gray-700 font-bold mb-2" for="price">Product Price</label>
    <input type="number" id="price" name="price" required
      class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
  </div>

  <div class="mb-4">
    <label class="block text-gray-700 font-bold mb-2" for="image">Product Image</label>
    <input type="file" id="image" name="image" accept="image/*" required class="w-full">
    <img id="preview" class="hidden mt-3 h-32 rounded-lg border" />
  </div>

  <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">Upload Product</button>
  <p id="msg" class="text-center mt-4 text-green-600"></p>
  <button type="button" onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded mt-2">Logout</button>
</form>

<div id="adminProducts" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const API = "https://dakaf-backend.onrender.com";
  const uploadForm = document.getElementById("uploadForm");
  const imageInput = document.getElementById("image");
  const preview = document.getElementById("preview");
  const msg = document.getElementById("msg");
  const container = document.getElementById("adminProducts");

  // ========== IMAGE PREVIEW ==========
  imageInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (!file) return;
    preview.src = URL.createObjectURL(file);
    preview.classList.remove("hidden");
  });

  // ========== SAFE FETCH FUNCTION ==========
  async function safeFetch(url, options = {}) {
  try {
    const res = await fetch(url, options);

    const contentType = res.headers.get("content-type");
    if (!res.ok) {
      const text = await res.text();
      throw new Error(`Server error: ${res.status} - ${text}`);
    }

    // Only parse JSON if response is actually JSON
    if (contentType && contentType.includes("application/json")) {
      return await res.json();
    } else {
      const text = await res.text();
      console.warn("Expected JSON but got:", text);
      return null;
    }

  } catch (err) {
    console.error(err);
    alert("Fetch error: " + err.message);
    return null;
  }
}


  // ========== UPLOAD PRODUCT ==========
  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(uploadForm);
    const data = await safeFetch(`${API}/products`, { method: "POST", body: formData });
    if (data) {
      msg.innerText = data.message;
      uploadForm.reset();
      preview.classList.add("hidden");
      loadAdminProducts();
    }
  });

  // ========== LOAD ALL PRODUCTS ==========
  async function loadAdminProducts() {
    const products = await safeFetch(`${API}/products`);
    if (!products) return;
    container.innerHTML = "";

    products.forEach(p => {
      container.innerHTML += `
        <div class="bg-white p-4 rounded shadow flex flex-col items-center">
          <img src="${p.image}" class="h-40 w-full object-cover rounded mb-2">
          <h2 class="font-semibold text-lg">${p.name}</h2>
          <p class="font-bold text-blue-600">â‚¦${p.price}</p>
          <div class="flex gap-2 mt-2">
            <button onclick='editProduct(${p.id})' class="bg-yellow-500 text-white px-3 py-1 rounded">Edit</button>
            <button onclick='deleteProduct(${p.id})' class="bg-red-600 text-white px-3 py-1 rounded">Delete</button>
          </div>
        </div>
      `;
    });
  }

  // ========== DELETE PRODUCT ==========
  window.deleteProduct = async function(id) {
    if (!confirm("Are you sure you want to delete this product?")) return;
    const data = await safeFetch(`${API}/products/${id}`, { method: "DELETE" });
    if (data) loadAdminProducts();
  };

  // ========== EDIT PRODUCT ==========
  window.editProduct = async function(id) {
    const name = prompt("Enter new product name:");
    const price = prompt("Enter new price:");
    if (!name && !price) return;

    const formData = new FormData();
    if (name) formData.append("name", name);
    if (price) formData.append("price", price);

    const data = await safeFetch(`${API}/products/${id}`, { method: "PUT", body: formData });
    if (data) loadAdminProducts();
  };

  // ========== LOGOUT ==========
  window.logout = function() {
    localStorage.clear();
    window.location.href = "login_page.html";
  };

  // ========== INITIAL LOAD ==========
  loadAdminProducts();
});
</script>

</body>
</html>
